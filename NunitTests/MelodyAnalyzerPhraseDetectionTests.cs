using NUnit.Framework;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Newtonsoft.Json;
using Sinphinity.Models;
using SinphinityProcMelodyAnalyser.BusinessLogic;
using System.IO;

namespace NunitTests
{
	internal class MelodyAnalyzerPhraseDetectionTests
	{

		private List<Note> notes = new List<Note>();


		private List<Bar> bars = new List<Bar>();


		[SetUp]
		public void Init()
		{
			var barsInv1AsString = @"[{""BarNumber"":1,""TicksFromBeginningOfSong"":0,""EndTick"":384,""TimeSignature"":{""Numerator"":4,""Denominator"":4},""KeySignature"":{""key"":0,""scale"":0},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":697674},{""BarNumber"":2,""TicksFromBeginningOfSong"":384,""EndTick"":768,""TimeSignature"":{""Numerator"":4,""Denominator"":4},""KeySignature"":{""key"":0,""scale"":0},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":697674},{""BarNumber"":3,""TicksFromBeginningOfSong"":768,""EndTick"":1152,""TimeSignature"":{""Numerator"":4,""Denominator"":4},""KeySignature"":{""key"":0,""scale"":0},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":697674},{""BarNumber"":4,""TicksFromBeginningOfSong"":1152,""EndTick"":1536,""TimeSignature"":{""Numerator"":4,""Denominator"":4},""KeySignature"":{""key"":0,""scale"":0},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":697674},{""BarNumber"":5,""TicksFromBeginningOfSong"":1536,""EndTick"":1920,""TimeSignature"":{""Numerator"":4,""Denominator"":4},""KeySignature"":{""key"":0,""scale"":0},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":697674},{""BarNumber"":6,""TicksFromBeginningOfSong"":1920,""EndTick"":2304,""TimeSignature"":{""Numerator"":4,""Denominator"":4},""KeySignature"":{""key"":0,""scale"":0},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":697674},{""BarNumber"":7,""TicksFromBeginningOfSong"":2304,""EndTick"":2688,""TimeSignature"":{""Numerator"":4,""Denominator"":4},""KeySignature"":{""key"":0,""scale"":0},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":697674},{""BarNumber"":8,""TicksFromBeginningOfSong"":2688,""EndTick"":3072,""TimeSignature"":{""Numerator"":4,""Denominator"":4},""KeySignature"":{""key"":0,""scale"":0},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":697674},{""BarNumber"":9,""TicksFromBeginningOfSong"":3072,""EndTick"":3456,""TimeSignature"":{""Numerator"":4,""Denominator"":4},""KeySignature"":{""key"":0,""scale"":0},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":697674},{""BarNumber"":10,""TicksFromBeginningOfSong"":3456,""EndTick"":3840,""TimeSignature"":{""Numerator"":4,""Denominator"":4},""KeySignature"":{""key"":0,""scale"":0},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":697674},{""BarNumber"":11,""TicksFromBeginningOfSong"":3840,""EndTick"":4224,""TimeSignature"":{""Numerator"":4,""Denominator"":4},""KeySignature"":{""key"":0,""scale"":0},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":697674},{""BarNumber"":12,""TicksFromBeginningOfSong"":4224,""EndTick"":4608,""TimeSignature"":{""Numerator"":4,""Denominator"":4},""KeySignature"":{""key"":0,""scale"":0},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":697674},{""BarNumber"":13,""TicksFromBeginningOfSong"":4608,""EndTick"":4992,""TimeSignature"":{""Numerator"":4,""Denominator"":4},""KeySignature"":{""key"":0,""scale"":0},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":697674},{""BarNumber"":14,""TicksFromBeginningOfSong"":4992,""EndTick"":5376,""TimeSignature"":{""Numerator"":4,""Denominator"":4},""KeySignature"":{""key"":0,""scale"":0},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":697674},{""BarNumber"":15,""TicksFromBeginningOfSong"":5376,""EndTick"":5760,""TimeSignature"":{""Numerator"":4,""Denominator"":4},""KeySignature"":{""key"":0,""scale"":0},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":697674},{""BarNumber"":16,""TicksFromBeginningOfSong"":5760,""EndTick"":6144,""TimeSignature"":{""Numerator"":4,""Denominator"":4},""KeySignature"":{""key"":0,""scale"":0},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":697674},{""BarNumber"":17,""TicksFromBeginningOfSong"":6144,""EndTick"":6528,""TimeSignature"":{""Numerator"":4,""Denominator"":4},""KeySignature"":{""key"":0,""scale"":0},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":697674},{""BarNumber"":18,""TicksFromBeginningOfSong"":6528,""EndTick"":6912,""TimeSignature"":{""Numerator"":4,""Denominator"":4},""KeySignature"":{""key"":0,""scale"":0},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":697674},{""BarNumber"":19,""TicksFromBeginningOfSong"":6912,""EndTick"":7296,""TimeSignature"":{""Numerator"":4,""Denominator"":4},""KeySignature"":{""key"":0,""scale"":0},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":697674},{""BarNumber"":20,""TicksFromBeginningOfSong"":7296,""EndTick"":7680,""TimeSignature"":{""Numerator"":4,""Denominator"":4},""KeySignature"":{""key"":0,""scale"":0},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":697674},{""BarNumber"":21,""TicksFromBeginningOfSong"":7680,""EndTick"":8064,""TimeSignature"":{""Numerator"":4,""Denominator"":4},""KeySignature"":{""key"":0,""scale"":0},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":697674},{""BarNumber"":22,""TicksFromBeginningOfSong"":8064,""EndTick"":8448,""TimeSignature"":{""Numerator"":4,""Denominator"":4},""KeySignature"":{""key"":0,""scale"":0},""HasTriplets"":true,""TempoInMicrosecondsPerQuarterNote"":697674}]";
			var barsInv4AsString = @"[{""BarNumber"":1,""TicksFromBeginningOfSong"":0,""EndTick"":144,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":2,""TicksFromBeginningOfSong"":144,""EndTick"":288,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":3,""TicksFromBeginningOfSong"":288,""EndTick"":432,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":4,""TicksFromBeginningOfSong"":432,""EndTick"":576,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":5,""TicksFromBeginningOfSong"":576,""EndTick"":720,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":6,""TicksFromBeginningOfSong"":720,""EndTick"":864,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":7,""TicksFromBeginningOfSong"":864,""EndTick"":1008,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":8,""TicksFromBeginningOfSong"":1008,""EndTick"":1152,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":9,""TicksFromBeginningOfSong"":1152,""EndTick"":1296,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":10,""TicksFromBeginningOfSong"":1296,""EndTick"":1440,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":11,""TicksFromBeginningOfSong"":1440,""EndTick"":1584,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":12,""TicksFromBeginningOfSong"":1584,""EndTick"":1728,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":13,""TicksFromBeginningOfSong"":1728,""EndTick"":1872,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":14,""TicksFromBeginningOfSong"":1872,""EndTick"":2016,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":15,""TicksFromBeginningOfSong"":2016,""EndTick"":2160,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":16,""TicksFromBeginningOfSong"":2160,""EndTick"":2304,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":17,""TicksFromBeginningOfSong"":2304,""EndTick"":2448,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":18,""TicksFromBeginningOfSong"":2448,""EndTick"":2592,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":19,""TicksFromBeginningOfSong"":2592,""EndTick"":2736,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":20,""TicksFromBeginningOfSong"":2736,""EndTick"":2880,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":21,""TicksFromBeginningOfSong"":2880,""EndTick"":3024,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":22,""TicksFromBeginningOfSong"":3024,""EndTick"":3168,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":23,""TicksFromBeginningOfSong"":3168,""EndTick"":3312,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":24,""TicksFromBeginningOfSong"":3312,""EndTick"":3456,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":25,""TicksFromBeginningOfSong"":3456,""EndTick"":3600,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":26,""TicksFromBeginningOfSong"":3600,""EndTick"":3744,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":27,""TicksFromBeginningOfSong"":3744,""EndTick"":3888,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":28,""TicksFromBeginningOfSong"":3888,""EndTick"":4032,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":29,""TicksFromBeginningOfSong"":4032,""EndTick"":4176,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":30,""TicksFromBeginningOfSong"":4176,""EndTick"":4320,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":31,""TicksFromBeginningOfSong"":4320,""EndTick"":4464,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":32,""TicksFromBeginningOfSong"":4464,""EndTick"":4608,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":33,""TicksFromBeginningOfSong"":4608,""EndTick"":4752,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":34,""TicksFromBeginningOfSong"":4752,""EndTick"":4896,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":35,""TicksFromBeginningOfSong"":4896,""EndTick"":5040,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":36,""TicksFromBeginningOfSong"":5040,""EndTick"":5184,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":37,""TicksFromBeginningOfSong"":5184,""EndTick"":5328,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":38,""TicksFromBeginningOfSong"":5328,""EndTick"":5472,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":39,""TicksFromBeginningOfSong"":5472,""EndTick"":5616,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":40,""TicksFromBeginningOfSong"":5616,""EndTick"":5760,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":41,""TicksFromBeginningOfSong"":5760,""EndTick"":5904,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":42,""TicksFromBeginningOfSong"":5904,""EndTick"":6048,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":43,""TicksFromBeginningOfSong"":6048,""EndTick"":6192,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":44,""TicksFromBeginningOfSong"":6192,""EndTick"":6336,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":45,""TicksFromBeginningOfSong"":6336,""EndTick"":6480,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":46,""TicksFromBeginningOfSong"":6480,""EndTick"":6624,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":47,""TicksFromBeginningOfSong"":6624,""EndTick"":6768,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":48,""TicksFromBeginningOfSong"":6768,""EndTick"":6912,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":49,""TicksFromBeginningOfSong"":6912,""EndTick"":7056,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":50,""TicksFromBeginningOfSong"":7056,""EndTick"":7200,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":51,""TicksFromBeginningOfSong"":7200,""EndTick"":7344,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":false,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":52,""TicksFromBeginningOfSong"":7344,""EndTick"":7488,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":true,""TempoInMicrosecondsPerQuarterNote"":606061},{""BarNumber"":53,""TicksFromBeginningOfSong"":7488,""EndTick"":7632,""TimeSignature"":{""Numerator"":3,""Denominator"":8},""KeySignature"":{""key"":-1,""scale"":1},""HasTriplets"":true,""TempoInMicrosecondsPerQuarterNote"":606061}]";
			bars = JsonConvert.DeserializeObject<List<Bar>>(barsInv4AsString);
			var dir = Directory.GetCurrentDirectory();
			var notesAsString = File.ReadAllText(@$"{dir}\Data\Invention4notes.txt");
			notes= JsonConvert.DeserializeObject<List<Note>>(notesAsString);

		}



		[Test]
		public void ExpectedPhrasesAreExtractedForInvention1()
        {
			var songSimplifications = new List<SongSimplification>();
			songSimplifications.Add(new SongSimplification { Notes = notes, NumberOfVoices = 2, Version = 0 });
			var song = new Song { Bars = bars, SongSimplifications = songSimplifications };
			MelodyFinder.FindAllPhrases(song, 0);
			Assert.IsTrue(true);
        }
		
	}
}

